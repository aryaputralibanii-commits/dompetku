<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DompetKeluarga - Multi-Bulan</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* CSS tetap sama dengan tambahan sedikit untuk filter */
        :root { --primary: #4e54c8; --secondary: #8f94fb; --income: #00b894; --expense: #d63031; --text: #2d3436; --card-bg: #ffffff; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .container { background: var(--card-bg); width: 100%; max-width: 480px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); padding: 30px; }
        header { text-align: center; margin-bottom: 20px; }
        
        /* Dropdown Filter Bulan */
        .month-selector { margin-bottom: 20px; text-align: center; }
        .month-selector select { padding: 8px 15px; border-radius: 10px; border: 2px solid var(--primary); font-family: inherit; font-weight: 600; cursor: pointer; color: var(--primary); }

        .balance-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 25px; }
        .balance-card h1 { font-size: 2.2rem; margin-top: 5px; }
        .summary-row { display: flex; justify-content: space-between; gap: 15px; margin-bottom: 25px; }
        .summary-box { flex: 1; background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .text-plus { color: var(--income); font-weight: 600; }
        .text-minus { color: var(--expense); font-weight: 600; }
        .form-control { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-size: 0.85rem; font-weight: 600; color: #636e72; }
        input { width: 100%; padding: 12px; border: 2px solid #f0f0f0; border-radius: 10px; font-size: 1rem; }
        .btn-group { display: flex; gap: 10px; margin: 15px 0; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; color: white; }
        .btn-inc { background: var(--income); }
        .btn-exp { background: var(--expense); }
        .list { list-style: none; max-height: 250px; overflow-y: auto; }
        .list li { background: #fff; display: flex; justify-content: space-between; padding: 12px; margin-bottom: 8px; border-radius: 10px; border-left: 5px solid #ddd; border-bottom: 1px solid #eee; }
        .list li.plus { border-left-color: var(--income); }
        .list li.minus { border-left-color: var(--expense); }
        .delete-btn { color: #b2bec3; border: none; background: none; font-size: 1.2rem; cursor: pointer; margin-left: 10px; }
        .file-section { margin-top: 20px; padding-top: 15px; border-top: 2px dashed #dfe6e9; text-align: center; font-size: 0.8rem; }
        .link-action { margin: 0 10px; color: var(--primary); cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h2>DompetKeluarga</h2>
        </header>

        <div class="month-selector">
            <label>Periode Laporan:</label>
            <input type="month" id="monthFilter" onchange="changeMonth()">
        </div>

        <div class="balance-card">
            <span>Saldo Periode Ini</span>
            <h1 id="balance">Rp 0</h1>
        </div>

        <div class="summary-row">
            <div class="summary-box">
                <h4>Masuk</h4>
                <p id="money-plus" class="text-plus">+Rp 0</p>
            </div>
            <div class="summary-box">
                <h4>Keluar</h4>
                <p id="money-minus" class="text-minus">-Rp 0</p>
            </div>
        </div>

        <div class="form-control">
            <label>Keterangan</label>
            <input type="text" id="text" placeholder="Gaji, Jajan, dll...">
        </div>

        <div class="form-control">
            <label>Nominal (Rp)</label>
            <input type="tel" id="amount" placeholder="0" onkeyup="formatInputUang(this)">
        </div>

        <div class="btn-group">
            <button class="btn btn-inc" onclick="addTransaction(true)">+ Masuk</button>
            <button class="btn btn-exp" onclick="addTransaction(false)">- Keluar</button>
        </div>

        <h3 style="font-size: 1rem; margin-bottom: 10px;">Riwayat Transaksi</h3>
        <ul id="list" class="list"></ul>

        <div class="file-section">
            <span class="link-action" onclick="downloadJSON()">ðŸ’¾ Backup</span>
            <span class="link-action" onclick="document.getElementById('fileInput').click()">ðŸ“‚ Restore</span>
            <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadJSON(this)">
        </div>
    </div>

    <script>
        const balance = document.getElementById('balance');
        const money_plus = document.getElementById('money-plus');
        const money_minus = document.getElementById('money-minus');
        const list = document.getElementById('list');
        const text = document.getElementById('text');
        const amountInput = document.getElementById('amount');
        const monthFilter = document.getElementById('monthFilter');

        // Set default input bulan ke bulan sekarang (format: YYYY-MM)
        const now = new Date();
        const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        monthFilter.value = currentMonthKey;

        // Ambil data semua bulan dari localStorage
        let allTransactions = JSON.parse(localStorage.getItem('allTransactions')) || {};

        function changeMonth() {
            updateUI();
        }

        function formatInputUang(input) {
            let value = input.value.replace(/[^,\d]/g, '').toString();
            let split = value.split(',');
            let sisa = split[0].length % 3;
            let rupiah = split[0].substr(0, sisa);
            let ribuan = split[0].substr(sisa).match(/\d{3}/gi);
            if (ribuan) {
                let separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }
            input.value = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
        }

        function addTransaction(isIncome) {
            const monthKey = monthFilter.value; // Ambil bulan yang sedang aktif
            const cleanAmount = amountInput.value.replace(/\./g, ''); 

            if (text.value.trim() === '' || cleanAmount === '') {
                alert('Isi data dengan benar');
                return;
            }

            let numberAmount = parseInt(cleanAmount);
            if (!isIncome) numberAmount = -Math.abs(numberAmount);

            const transaction = {
                id: Math.floor(Math.random() * 1000000),
                text: text.value,
                amount: numberAmount,
                date: new Date().toLocaleDateString('id-ID')
            };

            // Simpan ke dalam array bulan yang dipilih
            if (!allTransactions[monthKey]) {
                allTransactions[monthKey] = [];
            }
            
            allTransactions[monthKey].push(transaction);
            saveToLocal();
            updateUI();

            text.value = '';
            amountInput.value = '';
        }

        function removeTransaction(id) {
            const monthKey = monthFilter.value;
            allTransactions[monthKey] = allTransactions[monthKey].filter(t => t.id !== id);
            saveToLocal();
            updateUI();
        }

        function updateUI() {
            const monthKey = monthFilter.value;
            const currentData = allTransactions[monthKey] || [];
            
            list.innerHTML = '';
            let total = 0, income = 0, expense = 0;

            currentData.forEach(t => {
                const isMinus = t.amount < 0;
                total += t.amount;
                if(isMinus) expense += t.amount; else income += t.amount;

                const li = document.createElement('li');
                li.classList.add(isMinus ? 'minus' : 'plus');
                li.innerHTML = `
                    <div>
                        <strong>${t.text}</strong><br>
                        <small style="color:#999; font-size:0.7rem">${t.date}</small>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span class="${isMinus ? 'text-minus' : 'text-plus'}">
                            ${isMinus ? '-' : '+'} ${formatRupiah(Math.abs(t.amount))}
                        </span>
                        <button class="delete-btn" onclick="removeTransaction(${t.id})">Ã—</button>
                    </div>
                `;
                list.appendChild(li);
            });

            balance.innerText = formatRupiah(total);
            money_plus.innerText = `+${formatRupiah(income)}`;
            money_minus.innerText = `-${formatRupiah(Math.abs(expense))}`;
        }

        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        }

        function saveToLocal() {
            localStorage.setItem('allTransactions', JSON.stringify(allTransactions));
        }

        function downloadJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allTransactions));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", `Backup_Keuangan_${new Date().toLocaleDateString()}.json`);
            node.click();
        }

        function loadJSON(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                allTransactions = JSON.parse(e.target.result);
                saveToLocal();
                updateUI();
            };
            reader.readAsText(input.files[0]);
        }

        updateUI();
    </script>
</body>
</html><div class="file-section">
    <button class="btn" style="background: #2d3436; margin-bottom: 15px;" onclick="downloadMonthlyReport()">
        ðŸ“¥ Download Laporan Bulan Ini (.txt)
    </button>
    <br>
    <span class="link-action" onclick="downloadJSON()">ðŸ’¾ Backup Semua</span>
    <span class="link-action" onclick="document.getElementById('fileInput').click()">ðŸ“‚ Restore</span>
    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadJSON(this)">
</div>